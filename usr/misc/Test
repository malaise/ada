#!/bin/bash

# Automatic tests of misc

# Cleanup
function clean {
  rm -f cmp res
}

trap 'echo ""; clean; exit 1' SIGINT SIGTERM

function azf_one {
  export OPT=""
  if [ "$1" = "--lz4" ] ; then
    OPT="--lz4"
    shift
  fi
  local file=$1

  echo -n azf $OPT $file 
  cat $file | azf $OPT -s 900 -c > cmp
  if [ $? -ne 0 ] ; then
    echo
    echo "Azf $OPT -c $file has failed." 2>&1
    exit 1
  fi
  let ISIZE=0+`ls -l $file | cut -d ' ' -f 5` 
  let CSIZE=0+`ls -l cmp   | cut -d ' ' -f 5` 
  if [ $ISIZE -eq 0 ] ; then
    echo " 0"
  else
    let PER=\($ISIZE-$CSIZE\)*100/$ISIZE
    echo " "$PER"%"
  fi

  cat cmp | azf $OPT -s 900 -d > res
  if [ $? -ne 0 ] ; then
    echo
    echo "Azf $OPT -d on $file has failed." 2>&1
    exit 1
  fi

  cmp $file res 2>/dev/null
  res=$?
  if [ $res -ne 0 ] ; then
    echo
    echo "File res differs from original $file." 2>&1
    exit 1
  fi
}

if [ "$1"  = "-lzf" ] ; then
  shift
  for file in $* ; do
    azf_one $file
  done
  clean
  exit
elif [ "$1"  = "-lz4" ] ; then
  shift
  for file in $* ; do
    azf_one --lz4 $file
  done
  clean
  exit
fi

for file in `ls *.ads *.adb lib_Linux/*` ; do
  azf_one $file
  azf_one --lz4 $file
done

clean

