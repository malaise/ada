#!/bin/bash

function usage {
  echo "Usage: `basename $0` [ -w | --warnings ]"
  echo "    or `basename $0` [ -h | --help ]"
}

if [ \( "$1" = "-h"  \) -o \( "$1" = "--help" \) ] ; then
  usage
  exit 0
fi

WARN=""
if [ \( "$1" = "-w" \) -o \( "$1" = "--warnings" \) ] ; then
  WARN="-w"
  shift
fi

if [ -n "$1" ]  ; then
  usage
  exit 1
fi

echo Encode
while read -r lat lon || [[ -n "$lat" ]]; do
  if [ \( -z "$lat" \) -o \( "$lat" = "#" \) ] ; then
    continue
  fi
  t_accuracy $WARN $lat $lon >/dev/null
  res=$?
  if [ $res -ne 0 ] ; then
    if [ $res -eq 1 ] ; then
      exit 1
    else
      echo "Occured with " $lat " " $lon 1>&2
    fi
  fi
done < EncodeOk.txt

echo Decode
let L=0
while read -r ctx cod lat lon loc glob || [[ -n "$ctx" ]]; do
  if [ \( -z "$ctx" \) -o \( "$ctx" = "#" \) ] ; then
    continue
  fi
  t_accuracy $WARN $ctx:$cod >/dev/null
  res=$?
  if [ $res -ne 0 ] ; then
    if [ $res -eq 1 ] ; then
      exit 1
    else
      echo "Occurred with " $ctx:$cod 1>&2
    fi
  fi

  R=$((L % 100))
  if [ $R -eq 0 ] ; then
    echo -n "."
  fi
  let L=$L+1

done < DecodeOk.txt
echo

echo "Done."
