<?xml version="1.0"?>
<!DOCTYPE chats SYSTEM "chats.dtd">
<!-- Example of TCP chat script -->

<chats>
  <!-- HTTP 0.9: Send file -->
  <!-- HTTP 1.0 or 1.1: Send header + file -->
  <chat Name="http" TimeoutMs="&None;" Regexp="true"
        Assign="FILE=${1} VERS=${2}"
        >GET http://localhost([^ ]+)( +HTTP/1\.(0|1))</chat>
  <script>
    <cond>
      <if Variable="VERS"></if>
      <!-- No vers => 0.9 -->
      <script></script>
      <else/>
      <script>
        <!-- Vers 1.x => expect empty line and send header -->
        <read></read>
        <eval Variable="SIZE">ls -al ${FILE} | awk '{printf "%s",$5\}'</eval>
        <eval Variable="DATE">echo -n `date "+%a, %d %b %Y %H:%M:00 %Z"`</eval>
        <set Variable="SERVER_ID">tcpchat/V1.1</set>
        <send>HTTP/1.1 200 OK</send>
        <send>Date: ${DATE}</send>
        <send>Server: ${SERVER_ID}</send>
        <send>Connection: close</send>
        <send>Accept-Ranges: bytes</send>
        <send>Content-Length: ${SIZE}</send>
        <send>Content-Type: text/plain</send>
        <send></send>
      </script>
    </cond>
    <call>cat ${FILE}</call>
    <close/>
  </script>
  <!-- Tcping: Send pong and leav connected -->
  <chat Name="tcping" TimeoutMs="1_000" Regexp="true">(tc)?ping</chat>
  <script>
    <send>pong</send>
  </script>
  <!-- TEST wait then close -->
  <chat Name="testWaitClose">close</chat>
  <script>
    <wait DelayMs="1000"/>
    <close/>
  </script>
  <!-- TEST simulate a ppp login chat user side -->
  <chat Name="testPpp1">ppp1</chat>
  <script>
    <send>AT</send>
    <read TimeoutMs="5_000">OK</read>
    <send>ATQ0 V1 E1 S0=0 &amp;C1 &amp;D2 +FCLASS=0</send>
    <read TimeoutMs="5_000">OK</read>
    <send>ATDT0860922000</send>
    <select TimeoutMs="60_000">
      <expect Regexp="true">BUSY|ERROR|NO CARRIER|VOICE|NO DIAL ?TONE|NO ANSWER|DELAYED</expect>
      <script>
        <close/>
      </script>
      <expect Regexp="true">CONNECT( [0-9]+)?</expect>
      <script>
        <read TimeoutMs="30_000"Regexp="true">.ogin</read>
        <send>malaise</send>
        <read TimeoutMs="10_000" Regexp="true">.{4\}word</read>
        <send>${$PASSWORD}</send>
        <send>Working: Please wait...</send>
        <wait DelayMs="5_000"/>
        <send>Done. Please logout.</send>
        <read TimeoutMs="10_000">logout</read>
        <close/>
      </script>
    </select>
  </script>
  <!-- TEST simulate a ppp login chat modem side -->
  <chat Name="testPpp2">ppp2</chat>
  <script>
    <read>AT</read>
    <send>OK</send>
    <read>ATQ0 V1 E1 S0=0 &amp;C1 &amp;D2 +FCLASS=0</read>
    <send>OK</send>
    <read>ATDT0860922000</read>
    <wait DelayMs="21_000"/>
    <send>CONNECT 56000</send>
    <wait DelayMs="10_000"/>
    <send>login</send>
    <read>malaise</read>
    <send>password</send>
    <read>${$PASSWORD}</read>
    <send>Working: Please wait...</send>
    <wait DelayMs="5_000"/>
    <send>Done. Please logout.</send>
    <read TimeoutMs="10_000">logout</read>
    <close/>
  </script>
  <!-- TEST multiple select -->
  <chat Name="testMulti"
        InputDefaultTimeoutMs="None">testMulti</chat>
    <!-- A chat is like a expect, but with attibutes (Name...) -->
  <script>
    <send></send>
    <select>
      <expect>login</expect>
      <script>
        <send>me</send>
        <select>
          <expect>password</expect>
          <script>
            <send>pass</send>
          </script>
          <expect>PASSWORD</expect>
          <script>
            <send>PASS</send>
          </script>
          <default/>
          <script>
            <close/>
          </script>
        </select>
        <wait DelayMs="10"/>
        <send>ls</send>
      </script>
      <expect>LOGIN</expect>
      <script>
        <send>ME</send>
        <read>PASSWORD</read>
        <send>PASS</send>
      </script>
    </select>
    <wait DelayMs="1_000"/>
    <close/>
  </script>
</chats>

