<?xml version="1.0"?>
<!DOCTYPE chats SYSTEM "chats.dtd">
<!-- Example of TCP chat script -->

<chats>
  <!-- HTTP 0.9: Send file -->
  <!-- HTTP 1.0 or 1.1: Skip noise, send header + file -->
  <chat Name="http" TimeoutMs="&None;" Regexp="true"
        Assign="FILE=${4} VERS=${5}"
        >GET ((http:/)?/(localhost|${$HOSTNAME}))?([^ ]+)( +HTTP/1\.(0|1))?</chat>
  <script>
    <cond>
      <if Variable="VERS"></if>
      <!-- No vers => 0.9 -->
      <script></script>
      <else/>
      <script>
        <!-- Vers 1.x => skip inputs until empty line -->
        <set Variable="DONE">false</set>
        <repeat>
          <while Variable="DONE">false</while>
          <script>
            <select TimeoutMs="1000">
              <expect></expect>
              <script>
                <set Variable="DONE">true</set>
              </script>
              <default/>
              <script></script>
            </select>
          </script>
        </repeat>
        <!-- And send header -->
        <eval Variable="SIZE">
          <command>ls -al ${FILE} | awk '{printf "%s",$5\}'</command>
          <error/>
          <script>
            <set Variable="SIZE"></set>
          </script>
        </eval>
        <cond>
          <if Variable="SIZE"></if>
          <script>
            <send>HTTP/1.0 404 Not Found</send>
            <close/>
          </script>
        </cond>
        <eval Variable="DATE">
          <command>echo -n `date "+%a, %d %b %Y %H:%M:00 %Z"`</command>
        </eval>
        <set Variable="SERVER_ID">tcpchat/V2.1</set>
        <send>HTTP/1.0 200 OK</send>
        <send>Date: ${DATE}</send>
        <send>Server: ${SERVER_ID}</send>
        <send>Connection: close</send>
        <send>Accept-Ranges: bytes</send>
        <send>Content-Length: ${SIZE}</send>
        <send>Content-Type: text/plain</send>
        <send></send>
      </script>
    </cond>
    <call>
      <command>cat ${FILE}</command>
      <error/>
      <script>
        <cond>
          <if Variable="VERS"></if>
          <script></script>
          <else/>
          <script>
            <send>HTTP/1.0 404 Not Found</send>
          </script>
      </cond>
      </script>
    </call>
    <close/>
  </script>

  <!-- Tcping: Send pong and remain connected -->
  <chat Name="tcping" TimeoutMs="1_000" Regexp="true">(tc)?ping</chat>
  <script>
    <send NewLine="false">pong</send>
  </script>

  <!-- TEST wait then close -->
  <chat Name="testWaitClose">close</chat>
  <script>
    <wait DelayMs="1000"/>
    <close/>
  </script>

  <!-- TEST simulate a ppp login chat user side -->
  <chat Name="testPpp1">ppp1</chat>
  <script>
    <send>AT</send>
    <read TimeoutMs="5_000">OK</read>
    <send>ATQ0 V1 E1 S0=0 &amp;C1 &amp;D2 +FCLASS=0</send>
    <read TimeoutMs="5_000">OK</read>
    <send>ATDT0860922000</send>
    <select TimeoutMs="60_000">
      <expect Regexp="true">BUSY|ERROR|NO CARRIER|VOICE|NO DIAL ?TONE|NO ANSWER|DELAYED</expect>
      <script>
        <close/>
      </script>
      <expect Regexp="true">CONNECT( [0-9]+)?</expect>
      <script>
        <read TimeoutMs="30_000"Regexp="true">.ogin</read>
        <send>malaise</send>
        <read TimeoutMs="10_000" Regexp="true">.{4\}word</read>
        <send>${$PASSWORD}</send>
        <send>Working: Please wait...</send>
        <wait DelayMs="5_000"/>
        <send>Done. Please logout.</send>
        <read TimeoutMs="10_000">logout</read>
        <close/>
      </script>
    </select>
  </script>
  <!-- TEST simulate a ppp login chat modem side -->
  <chat Name="testPpp2">ppp2</chat>
  <script>
    <read>AT</read>
    <send>OK</send>
    <read>ATQ0 V1 E1 S0=0 &amp;C1 &amp;D2 +FCLASS=0</read>
    <send>OK</send>
    <read>ATDT0860922000</read>
    <wait DelayMs="21_000"/>
    <send>CONNECT 56000</send>
    <wait DelayMs="10_000"/>
    <send>login</send>
    <read>malaise</read>
    <send>password</send>
    <read>${$PASSWORD}</read>
    <send>Working: Please wait...</send>
    <wait DelayMs="5_000"/>
    <send>Done. Please logout.</send>
    <read TimeoutMs="10_000">logout</read>
    <close/>
  </script>

  <!-- TEST multiple select -->
  <chat Name="testMulti"
        InputDefaultTimeoutMs="None">testMulti</chat>
  <script>
    <send></send>
    <select>
      <expect>login</expect>
      <script>
        <send>me</send>
        <select>
          <expect>password</expect>
          <script>
            <send>pass</send>
          </script>
          <expect>PASSWORD</expect>
          <script>
            <send>PASS</send>
          </script>
          <default/>
          <script>
            <close/>
          </script>
        </select>
        <wait DelayMs="10"/>
        <send>ls</send>
      </script>
      <expect>LOGIN</expect>
      <script>
        <send>ME</send>
        <read>PASSWORD</read>
        <send>PASS</send>
      </script>
    </select>
    <wait DelayMs="1_000"/>
    <close/>
  </script>

  <!-- TEST a login -->
  <chat Name="login" TimeoutMs="60_000">login</chat>
  <script>
    <set Variable="COUNT">0</set>
    <set Variable="RES">try</set>
    <repeat>
      <while Variable="RES">try</while>
      <script>
        <!-- Get login and password, set RES=loggedin if OK -->
        <send>login:</send>
        <read Regexp="true" Assign="USER=${0}">.*</read>
        <send>password:</send>
        <read Regexp="true" Assign="PASSWD=${0}">.*</read>
        <cond>
          <if Variable="USER">malaise</if>
          <script>
            <cond>
              <if Variable="PASSWD">${$PASSWORD}</if>
              <script>
                <set Variable="RES">success</set>
              </script>
            </cond>
          </script>
        </cond>
        <!-- Increment counter if not OK, failed if maximum reached -->
        <cond>
          <if Variable="RES">try</if>
          <script>
            <set Variable="COUNT" Compute="true">${COUNT}+1</set>
            <cond>
              <if Variable="COUNT">5</if>
              <script>
                <set Variable="RES">failure</set>
              </script>
            </cond>
          </script>
        </cond>
      </script>
    </repeat>
    <!-- Put result -->
    <cond>
      <if Variable="RES">success</if>
      <script>
        <send>User ${USER} logged in</send>
        <log>User ${USER} logged in</log>
      </script>
      <else/>
      <script>
        <send>Login failed</send>
        <log>Login failed</log>
        <set Variable="USER"></set>
         <close/>
      </script>
    </cond>
  </script>
  <chat Name="logout">logout</chat>
  <script>
    <cond>
      <if Variable="USER" IfUnset="true"></if>
      <script></script>
      <else/>
      <script>
        <send>User ${USER} logged out</send>
        <log>User ${USER} logged out</log>
      </script>
    </cond>
    <close/>
  </script>

  <chat Name="error1">error1</chat>
  <script>
    <chdir>
      <dir>Unknown</dir>
      <error/>
      <script>
        <send>error-handler-1</send>
      </script>
    </chdir>
  </script>
  <chat Name="error2">error2</chat>
  <script>
    <chdir>
      <dir>Unknown</dir>
      <error/>
      <script>
        <send>error-handler-2</send>
      </script>
    </chdir>
    <send>after-error-2</send>
  </script>

  <chat Name="Indirect">indirect</chat>
  <script>
    <set Variable="V1">Content1</set>
    <set Variable="V2">Content2</set>
    <read Regexp="true" Assign="Index=${0}">.*</read>
    <set Variable="Index" Compute="true">${Index}+1</set>
    <set Variable="Result">${V${Index}}</set>
    <send NewLine="false">${Result}</send>
  </script>

</chats>

